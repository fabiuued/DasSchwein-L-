<!DOCTYPE html> 
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bounce Blast Pro - Power-Up Edition</title>
    <style>
        :root { --bg-color: #121212; --accent-color: #00bcd4; }
        body {
            margin: 0; padding: 0; background-color: var(--bg-color); color: white;
            font-family: sans-serif; height: 100vh; width: 100vw; overflow: hidden;
            display: flex; flex-direction: row;
        }

        /* Leaderboard Style */
        #leaderboard {
            width: 220px; background: #1a1a1a; border-right: 2px solid #333;
            display: flex; flex-direction: column; padding: 20px; box-sizing: border-box;
        }
        #leaderboard h2 { font-size: 18px; color: var(--accent-color); margin-top: 0; text-align: center; }
        #highscores-list { flex-grow: 1; }
        .score-entry { 
            margin: 12px 0; font-size: 14px; border-bottom: 1px solid #333; 
            padding-bottom: 5px; display: flex; justify-content: space-between;
        }
        .score-entry span { color: var(--accent-color); font-weight: bold; }

        /* Game Area */
        #game-section { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        #game-wrapper { position: relative; width: 100%; height: 75vh; display: flex; justify-content: center; align-items: center; }
        canvas { 
            max-width: 100%; max-height: 100%; aspect-ratio: 3/4; 
            background-color: #000; cursor: crosshair; border: 2px solid #333;
        }

        #ui-layer { height: 25vh; width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #222; }
        .btn-row { display: flex; gap: 10px; margin-bottom: 5px; }
        
        button, .custom-file-upload {
            padding: 10px 15px; border-radius: 5px; border: none; cursor: pointer;
            font-weight: bold; font-size: 14px; text-transform: uppercase; transition: 0.2s;
        }
        button:hover { opacity: 0.8; }
        button:disabled { background: #555; cursor: not-allowed; }
        
        button { background-color: var(--accent-color); color: white; }
        .save-btn { background-color: #4caf50; display: none; }
        .custom-file-upload { background: #e91e63; color: white; }
        #fileInput { display: none; }

        #score-overlay { position: absolute; top: 15px; left: 15px; font-size: 22px; font-weight: bold; text-shadow: 2px 2px #000; }
        #hp-display { position: absolute; top: 15px; right: 15px; font-size: 22px; }
        #powerup-info { position: absolute; bottom: 10px; left: 10px; font-size: 14px; color: #ffeb3b; }

        @media (max-width: 600px) {
            body { flex-direction: column; }
            #leaderboard { width: 100%; height: 120px; border-right: none; border-bottom: 2px solid #333; padding: 10px; }
            #highscores-list { display: flex; justify-content: space-around; }
            .score-entry { border-bottom: none; margin: 0; flex-direction: column; align-items: center; }
        }
    </style>
</head>
<body>

    <div id="leaderboard">
        <h2>üèÜ Weltweite Top 3</h2>
        <div id="highscores-list">Lade Daten...</div>
    </div>

    <div id="game-section">
        <div id="game-wrapper">
            <canvas id="gameCanvas" width="600" height="800"></canvas>
            <div id="score-overlay">Score: 0</div>
            <div id="hp-display">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
            <div id="powerup-info"></div>
        </div>

        <div id="ui-layer">
            <div class="btn-row">
                <button onclick="resetGame()">Neustart</button>
                <button id="saveScoreBtn" class="save-btn" onclick="saveCurrentScore()">Score Speichern</button>
                <label for="fileInput" class="custom-file-upload">üì∑ Ball-Bild</label>
            </div>
            <input id="fileInput" type="file" accept="image/*" />
            <p id="player-name-tag" style="margin: 5px; color: var(--accent-color); font-weight: bold;"></p>
        </div>
    </div>

<script>
    // ==========================================
    // DEIN GOOGLE SCRIPT LINK HIER EINF√úGEN:
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxy_b0gXdESrPv_xPxTjMFwYzcw3qTraEm8qtxLyx64dl-RVeb5GUy_cMCE4vllXkKpDg/exec"; 
    // ==========================================

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score-overlay');
    const hpEl = document.getElementById('hp-display');
    const saveBtn = document.getElementById('saveScoreBtn');
    const nameTag = document.getElementById('player-name-tag');
    const pwrEl = document.getElementById('powerup-info');

    let playerName = "";
    let animationId, score = 0, frames = 0, gameOver = false, userImage = null;
    let player = { x: 300, y: 740, w: 40, h: 40, hp: 5, invincible: 0, damage: 1 };
    let bullets = [], enemyBullets = [], balls = [], powerups = [], keys = { ArrowLeft: false, ArrowRight: false };

    // Power-Up Status
    let fastFireTimer = 0;
    let tripleShotTimer = 0;

    function init() {
        playerName = prompt("Bitte gib deinen Namen f√ºr die Weltbesten liste ein:", "Spieler") || "Unbekannt";
        nameTag.innerText = "Pilot: " + playerName;
        loadHighscores();
        resetGame();
    }

    async function loadHighscores() {
        const list = document.getElementById('highscores-list');
        try {
            const response = await fetch(GOOGLE_SCRIPT_URL);
            const data = await response.json();
            list.innerHTML = data.map((s, i) => `<div class="score-entry"><div>${i+1}. ${s.name}</div><span>${s.score}</span></div>`).join('');
        } catch (err) { list.innerHTML = "Fehler beim Laden."; }
    }

    async function saveCurrentScore() {
        saveBtn.innerText = "Speichere...";
        saveBtn.disabled = true;
        const url = `${GOOGLE_SCRIPT_URL}?name=${encodeURIComponent(playerName)}&score=${score}`;
        try {
            await fetch(url, { method: 'POST' });
            alert("Score weltweit gespeichert!");
            saveBtn.style.display = "none";
            loadHighscores();
        } catch (err) { alert("Fehler!"); saveBtn.disabled = false; saveBtn.innerText = "Score Speichern"; }
    }

    // --- KLASSEN ---
    class Bullet {
        constructor(x, y, angle = 0) { this.x = x; this.y = y; this.r = 6; this.del = false; this.angle = angle; }
        update() { 
            this.y -= 12; 
            this.x += this.angle;
            if (this.y < 0) this.del = true; 
        }
        draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.r, 0, Math.PI*2); ctx.fillStyle = '#ffeb3b'; ctx.fill(); }
    }

    class PowerUp {
        constructor(x, y, type) {
            this.x = x; this.y = y; this.type = type; // 0: Fast, 1: Triple, 2: Damage
            this.size = 20; this.del = false;
        }
        update() { this.y += 3; if (this.y > canvas.height) this.del = true; }
        draw() {
            ctx.fillStyle = this.type === 0 ? '#00ff00' : (this.type === 1 ? '#e91e63' : '#ff9800');
            ctx.beginPath();
            if (this.type === 0) { // Dreieck (Fast Fire)
                ctx.moveTo(this.x, this.y - 12); ctx.lineTo(this.x - 12, this.y + 12); ctx.lineTo(this.x + 12, this.y + 12);
            } else if (this.type === 1) { // Quadrat (Triple)
                ctx.rect(this.x - 10, this.y - 10, 20, 20);
            } else { // Stern-ish (Permanent Damage)
                for(let i=0; i<5; i++) {
                    ctx.lineTo(Math.cos((18+i*72)/180*Math.PI)*15+this.x, -Math.sin((18+i*72)/180*Math.PI)*15+this.y);
                    ctx.lineTo(Math.cos((54+i*72)/180*Math.PI)*7+this.x, -Math.sin((54+i*72)/180*Math.PI)*7+this.y);
                }
            }
            ctx.closePath(); ctx.fill();
        }
    }

    class EnemyBullet {
        constructor(x, y) { this.x = x; this.y = y; this.r = 6; this.del = false; }
        update() { this.y += 4; if (this.y > canvas.height) this.del = true; }
        draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.r, 0, Math.PI*2); ctx.fillStyle = '#ff5252'; ctx.fill(); }
    }

    class Ball {
        constructor(x, y, r, hp) {
            this.x = x; this.y = y; this.r = r; this.hp = hp;
            this.vx = (Math.random() < 0.5 ? -1 : 1) * (1 + Math.random()*2);
            this.vy = 2; this.gravity = 0.15; this.del = false;
        }
        update() {
            this.vy += this.gravity; this.x += this.vx; this.y += this.vy;
            if (this.x + this.r > canvas.width || this.x - this.r < 0) this.vx *= -1;
            if (this.y + this.r > canvas.height - 80) { this.y = canvas.height - 80 - this.r; this.vy *= -0.92; }
            if (frames % 80 === 0 && Math.random() < 0.3) enemyBullets.push(new EnemyBullet(this.x, this.y + this.r));
        }
        draw() {
            ctx.save();
            ctx.beginPath(); ctx.arc(this.x, this.y, this.r, 0, Math.PI*2); ctx.clip();
            if (userImage) { ctx.drawImage(userImage, this.x - this.r, this.y - this.r, this.r*2, this.r*2); }
            else { ctx.fillStyle = '#444'; ctx.fill(); }
            ctx.restore();
            ctx.fillStyle = 'white'; ctx.font = 'bold 22px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(this.hp, this.x, this.y);
        }
    }

    // --- ENGINE ---
    function animate() {
        if (gameOver) { drawGameOver(); saveBtn.style.display = "inline-block"; return; }
        animationId = requestAnimationFrame(animate);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        frames++;

        // Timers reduzieren
        if (fastFireTimer > 0) fastFireTimer--;
        if (tripleShotTimer > 0) tripleShotTimer--;
        pwrEl.innerText = (fastFireTimer > 0 ? "SPEED UP " : "") + (tripleShotTimer > 0 ? "TRIPLE " : "") + (player.damage > 1 ? "DMG+"+(player.damage-1) : "");

        // Player Bewegung & Teleport
        if (keys.ArrowLeft) player.x -= 8;
        if (keys.ArrowRight) player.x += 8;
        if (player.x < 0) player.x = canvas.width;
        if (player.x > canvas.width) player.x = 0;
        
        if (player.invincible > 0) { player.invincible--; if (Math.floor(frames/5)%2===0) drawPlayer(); }
        else drawPlayer();

        // Schie√üen
        let rate = fastFireTimer > 0 ? 4 : 8;
        if (frames % rate === 0) {
            if (tripleShotTimer > 0) {
                bullets.push(new Bullet(player.x, player.y - 20, 0));
                bullets.push(new Bullet(player.x, player.y - 20, -3));
                bullets.push(new Bullet(player.x, player.y - 20, 3));
            } else {
                bullets.push(new Bullet(player.x, player.y - 20));
            }
        }

        // Power-Up Spawn
        let rand = Math.random() * 100;
        if (rand < 0.04) powerups.push(new PowerUp(Math.random()*canvas.width, -20, 0));
        else if (rand < 0.08) powerups.push(new PowerUp(Math.random()*canvas.width, -20, 1));
        else if (rand < 0.11) powerups.push(new PowerUp(Math.random()*canvas.width, -20, 2));

        if (frames % 120 === 0) spawnBall();

        bullets.forEach((b, i) => { b.update(); b.draw(); if(b.del) bullets.splice(i,1); });
        enemyBullets.forEach((eb, i) => { eb.update(); eb.draw(); if(eb.del) enemyBullets.splice(i,1); });
        powerups.forEach((p, i) => { 
            p.update(); p.draw(); 
            if (Math.hypot(player.x-p.x, player.y-p.y) < 30) {
                if (p.type === 0) fastFireTimer = 600;
                if (p.type === 1) tripleShotTimer = 600;
                if (p.type === 2) player.damage += 1;
                p.del = true;
            }
            if(p.del) powerups.splice(i,1);
        });
        
        balls.forEach(ball => {
            ball.update(); ball.draw();
            bullets.forEach(bullet => {
                if (!bullet.del && Math.hypot(bullet.x-ball.x, bullet.y-ball.y) < ball.r+bullet.r) {
                    ball.hp -= player.damage; bullet.del = true; score += 10;
                    scoreEl.innerText = "Score: " + score;
                    if (ball.hp <= 0) ball.del = true;
                }
            });
            if (player.invincible === 0 && Math.hypot(player.x-ball.x, player.y-ball.y) < ball.r+20) playerHit();
        });

        enemyBullets.forEach(eb => {
            if (player.invincible === 0 && eb.x > player.x-20 && eb.x < player.x+20 && eb.y > player.y && eb.y < player.y+40) {
                eb.del = true; playerHit();
            }
        });
        balls = balls.filter(b => !b.del);
    }

    function spawnBall() {
        const r = 30 + Math.random()*20;
        balls.push(new Ball(Math.random()*(canvas.width-100)+50, -50, r, 3 + Math.floor(score/200)));
    }

    function drawPlayer() {
        ctx.fillStyle = '#00bcd4';
        ctx.fillRect(player.x - 20, player.y, 40, 40);
        ctx.fillRect(player.x - 8, player.y - 15, 16, 15);
    }

    function playerHit() {
        player.hp--; player.invincible = 60;
        let h = ""; for(let i=0; i<player.hp; i++) h += "‚ù§Ô∏è"; hpEl.innerText = h;
        if (player.hp <= 0) gameOver = true;
    }

    function drawGameOver() {
        ctx.fillStyle = 'rgba(0,0,0,0.8)'; ctx.fillRect(0,0,canvas.width, canvas.height);
        ctx.fillStyle = 'white'; ctx.textAlign = 'center'; ctx.font = '50px Arial';
        ctx.fillText("GAME OVER", canvas.width/2, canvas.height/2);
    }

    function resetGame() {
        if (animationId) cancelAnimationFrame(animationId);
        score = 0; frames = 0; gameOver = false; bullets = []; enemyBullets = []; balls = []; powerups = [];
        player.hp = 5; player.invincible = 0; player.damage = 1; fastFireTimer = 0; tripleShotTimer = 0;
        saveBtn.style.display = "none"; saveBtn.disabled = false; saveBtn.innerText = "Score Speichern";
        scoreEl.innerText = "Score: 0"; hpEl.innerText = "‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è";
        animate();
    }

    // Bild-Upload Logik
    document.getElementById('fileInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                const img = new Image();
                img.onload = () => { userImage = img; };
                img.src = evt.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    canvas.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect();
        player.x = (e.clientX - rect.left) * (canvas.width / rect.width);
    });
    window.addEventListener('keydown', e => { if(e.key in keys) keys[e.key] = true; });
    window.addEventListener('keyup', e => { if(e.key in keys) keys[e.key] = false; });

    init();
</script>
</body>
</html>
